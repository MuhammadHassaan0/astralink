<!DOCTYPE html>
<html class="dark" lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>AstraLink – Profile</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Spectral:wght@500;600&display=swap" rel="stylesheet"/>
  <script src="/app.js" defer></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #0A0E27;
      color: #f5f5f5;
    }
    .container-shell {
      max-width: 960px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }
    .section-card {
      background: rgba(10, 13, 27, 0.82);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 24px;
      padding: 28px 32px;
      box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);
      backdrop-filter: blur(20px);
    }
    .field {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.08);
      color: #f7f8ff;
    }
    .field:focus {
      border-color: rgba(139,127,214,0.7);
      box-shadow: 0 0 0 2px rgba(139,127,214,0.25);
    }
    .brand-mark {
      font-family: 'Spectral', serif;
      letter-spacing: 0.05em;
      font-size: 1.3rem;
    }
  </style>
</head>
<body>
  <div class="container-shell space-y-8">
    <header class="flex items-center justify-between">
      <a href="/beta" class="brand-mark text-white">AstraLink</a>
      <nav class="hidden md:flex gap-6 text-sm text-white/70">
        <a href="/beta" class="hover:text-white">Home</a>
        <a href="/beta/how" class="hover:text-white">How it works</a>
        <span class="text-white font-semibold">Build</span>
        <a href="/beta/chat" class="hover:text-white">Chat</a>
      </nav>
      <div class="flex items-center gap-3 text-sm text-white/70">
        <span id="sessionBadge">Session —</span>
        <button id="logoutBtn" class="px-3 py-1 border border-white/20 rounded-full hover:bg-white/10 transition">Log out</button>
      </div>
    </header>

    <section class="section-card space-y-6">
      <div class="text-center space-y-3">
        <p class="text-xs uppercase tracking-[0.3em] text-white/60">Step 1</p>
        <h1 class="text-3xl font-semibold" style="font-family:'Spectral',serif;">Set up who they are</h1>
        <p class="text-white/70 text-sm max-w-2xl mx-auto">These details help AstraLink mirror their tone and relationship to you.</p>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <label class="text-sm text-white/70 space-y-1">
          Their name
          <input id="profileName" type="text" class="field w-full rounded-xl px-4 py-2.5" placeholder="e.g., Haroon"/>
        </label>
        <label class="text-sm text-white/70 space-y-1">
          Your relationship
          <input id="profileRelationship" type="text" class="field w-full rounded-xl px-4 py-2.5" placeholder="Son, daughter, friend..."/>
        </label>
        <label class="text-sm text-white/70 space-y-1">
          What do they call you?
          <input id="profileCallYou" type="text" class="field w-full rounded-xl px-4 py-2.5" placeholder="beta, love, champ..."/>
        </label>
        <label class="text-sm text-white/70 space-y-1">
          Mode
          <select id="profileMode" class="field w-full rounded-xl px-4 py-2.5 bg-transparent">
            <option value="memory">In Memory (passed)</option>
            <option value="alive">Alive / Unavailable</option>
          </select>
        </label>
        <label class="text-sm text-white/70 space-y-1 md:col-span-2">
          Traits (comma separated)
          <input id="profileTraits" type="text" class="field w-full rounded-xl px-4 py-2.5" placeholder="caring, practical, witty"/>
        </label>
        <label class="text-sm text-white/70 space-y-1 md:col-span-2">
          Catchphrases (comma separated)
          <input id="profileCatchphrases" type="text" class="field w-full rounded-xl px-4 py-2.5" placeholder="one step at a time, breathe first"/>
        </label>
      </div>
      <div class="flex flex-wrap items-center gap-4">
        <button id="saveProfileBtn" class="px-6 py-3 rounded-full bg-gradient-to-r from-[#6EACDA] to-[#8B7FD6] text-primary font-semibold shadow-lg hover:opacity-90 transition">Save profile</button>
        <p id="profileStatus" class="text-sm text-white/70"></p>
      </div>
      <div class="text-center text-sm text-white/70">
        Ready for the next step? <a href="/beta/memories" class="text-[#8B7FD6] underline">Upload memories →</a>
      </div>
    </section>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const inputs = {
        name: document.getElementById("profileName"),
        relationship: document.getElementById("profileRelationship"),
        call_you: document.getElementById("profileCallYou"),
        mode: document.getElementById("profileMode"),
        traits: document.getElementById("profileTraits"),
        catchphrases: document.getElementById("profileCatchphrases"),
      };
      const statusEl = document.getElementById("profileStatus");
      const sessionBadge = document.getElementById("sessionBadge");
      const logoutBtn = document.getElementById("logoutBtn");

      function updateSessionBadge() {
        const sid = Astralink.getSessionId();
        sessionBadge.textContent = sid ? `Session ${sid.slice(0, 8)}…` : "Session —";
      }

      function loadProfileFromStorage() {
        const stored = Astralink.getProfile();
        if (!stored) return;
        inputs.name.value = stored.name || "";
        inputs.relationship.value = stored.relationship || "";
        inputs.call_you.value = stored.call_you || "";
        inputs.mode.value = stored.mode || "memory";
        inputs.traits.value = (stored.traits || []).join(", ");
        inputs.catchphrases.value = (stored.catchphrases || []).join(", ");
      }

      function splitList(value) {
        return (value || "")
          .split(",")
          .map((part) => part.trim())
          .filter(Boolean);
      }

      async function handleSaveProfile() {
        const profile = {
          name: inputs.name.value.trim(),
          relationship: inputs.relationship.value.trim(),
          call_you: inputs.call_you.value.trim(),
          mode: Astralink.normalizeMode(inputs.mode.value),
          traits: splitList(inputs.traits.value),
          catchphrases: splitList(inputs.catchphrases.value),
        };
        statusEl.textContent = "Saving…";
        try {
          const data = await Astralink.saveProfile(profile);
          statusEl.textContent = "Saved. Session updated.";
          updateSessionBadge();
        } catch (err) {
          statusEl.textContent = err.message || "Save failed.";
        }
      }

      function configureAuthButton() {
        if (Astralink.isAuthenticated()) {
          logoutBtn.textContent = "Log out";
          logoutBtn.addEventListener("click", async () => {
            await Astralink.logoutAccount();
            window.location.reload();
          });
        } else {
          logoutBtn.textContent = "Log in";
          logoutBtn.addEventListener("click", () => {
            window.location.href = "/beta/auth";
          });
        }
      }

      document.getElementById("saveProfileBtn").addEventListener("click", handleSaveProfile);

      loadProfileFromStorage();
      updateSessionBadge();
      configureAuthButton();
    });
  </script>
</body>
</html>
